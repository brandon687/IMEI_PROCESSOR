{% extends "base.html" %}

{% block title %}Database - SCal Mobile IMEI Checker{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto;">
    <h2 style="color: #1A1A1A; margin-bottom: 40px; text-align: center; font-weight: 700;">IMEI Orders Database</h2>

    <!-- Statistics -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px;">
        <div class="card" style="text-align: center; border: 2px solid #2C2C2C;">
            <h3 style="color: #1A1A1A; font-size: 2.5em; margin-bottom: 10px; font-weight: 700;">{{ stats.total_orders }}</h3>
            <p style="color: #757575; font-weight: 300;">Total Orders</p>
        </div>

        <div class="card" style="text-align: center;">
            <h3 style="color: #1A1A1A; font-size: 2.5em; margin-bottom: 10px; font-weight: 700;">${{ "%.2f"|format(stats.total_credits) }}</h3>
            <p style="color: #757575; font-weight: 300;">Total Credits</p>
        </div>

        <div class="card" style="text-align: center;">
            <h3 style="color: #1A1A1A; font-size: 2.5em; margin-bottom: 10px; font-weight: 700;">{{ stats.orders_today }}</h3>
            <p style="color: #757575; font-weight: 300;">Orders Today</p>
        </div>
    </div>

    <!-- Actions -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px;">
        <div class="card" style="text-align: center;">
            <h3 style="color: #1A1A1A; margin-bottom: 15px; font-weight: 600;">Sync & Parse</h3>
            <p style="color: #757575; margin-bottom: 10px; font-weight: 300; font-size: 0.85em;">Sync pending orders with parser</p>
            <button id="manual-sync-btn" class="btn" style="background: #00A86B; font-size: 0.85em; padding: 8px 15px; width: 100%; border: none; cursor: pointer;">
                <span id="sync-btn-text">üîÑ Manual Sync & Parse Orders</span>
            </button>
            <div id="sync-status" style="margin-top: 10px; font-size: 0.75em; color: #757575;"></div>
        </div>

        <div class="card" style="text-align: center;">
            <h3 style="color: #1A1A1A; margin-bottom: 15px; font-weight: 600;">Import Data</h3>
            <p style="color: #757575; margin-bottom: 20px; font-weight: 300; font-size: 0.9em;">Upload Hammer Fusion export file</p>
            <a href="/database/import" class="btn" style="font-size: 0.9em;">Import Excel File</a>
        </div>

        <div class="card" style="text-align: center;">
            <h3 style="color: #1A1A1A; margin-bottom: 15px; font-weight: 600;">Download CSV</h3>
            <p style="color: #757575; margin-bottom: 10px; font-weight: 300; font-size: 0.85em;">Download directly to computer</p>
            <a href="/download-completed-csv" class="btn" style="background: #2C2C2C; font-size: 0.85em; padding: 8px 15px; margin-bottom: 8px; display: block;">üì• Completed Orders</a>
            <a href="/download-csv" class="btn" style="background: #757575; font-size: 0.85em; padding: 8px 15px; display: block;">üì• All Orders</a>
        </div>

        <div class="card" style="text-align: center;">
            <h3 style="color: #1A1A1A; margin-bottom: 15px; font-weight: 600;">Cloud Export</h3>
            <p style="color: #757575; margin-bottom: 10px; font-weight: 300; font-size: 0.85em;">Upload to Supabase Storage</p>
            <a href="/export-completed" class="btn" style="background: #00A86B; font-size: 0.85em; padding: 8px 15px; margin-bottom: 8px; display: block;">‚òÅÔ∏è Completed Orders</a>
            <a href="/export-all" class="btn" style="background: #008B5A; font-size: 0.85em; padding: 8px 15px; display: block;">‚òÅÔ∏è All Orders</a>
        </div>

        <div class="card" style="text-align: center;">
            <h3 style="color: #1A1A1A; margin-bottom: 15px; font-weight: 600;">Search</h3>
            <p style="color: #757575; margin-bottom: 10px; font-weight: 300; font-size: 0.85em;">Find orders by IMEI, model, carrier</p>
            <form method="GET" action="/database/search">
                <input type="text" name="q" placeholder="Search..." style="width: 100%; padding: 10px; border: 2px solid #E0E0E0; margin-bottom: 10px; font-size: 0.9em;">
                <button type="submit" class="btn" style="width: 100%; font-size: 0.9em;">Search</button>
            </form>
        </div>
    </div>

    <!-- Orders by Status -->
    {% if stats.by_status %}
    <div class="card">
        <h3 style="color: #1A1A1A; margin-bottom: 20px; font-weight: 600;">Orders by Status</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
            {% for status, count in stats.by_status.items() %}
            <div style="padding: 15px; background: #F9F9F9; border: 1px solid #E0E0E0; text-align: center;">
                <div style="font-size: 1.5em; font-weight: 700; color: #1A1A1A; margin-bottom: 5px;">{{ count }}</div>
                <div style="color: #757575; font-size: 0.9em;">{{ status or 'Unknown' }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Recent Orders -->
    <div class="card">
        <h3 style="color: #1A1A1A; margin-bottom: 20px; font-weight: 600;">Recent Orders (Last 20)</h3>

        {% if recent_orders %}
        <table class="table">
            <thead>
                <tr>
                    <th>#ID</th>
                    <th>STATUS</th>
                    <th>SERVICE</th>
                    <th>IMEI #</th>
                    <th>CODE</th>
                </tr>
            </thead>
            <tbody>
                {% for order in recent_orders %}
                <tr>
                    <td><span class="badge badge-info">{{ order.order_id or 'N/A' }}</span></td>
                    <td>
                        {% if order.status == 'Completed' %}
                            <span class="badge badge-success">{{ order.status }}</span>
                        {% elif order.status in ['Pending', 'In Process'] %}
                            <span class="badge badge-warning">{{ order.status }}</span>
                        {% else %}
                            <span class="badge badge-danger">{{ order.status or 'Unknown' }}</span>
                        {% endif %}
                    </td>
                    <td style="font-size: 0.75em; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ order.service_name }}">{{ order.service_name or order.service_id or 'N/A' }}</td>
                    <td style="font-family: monospace;"><strong>{{ order.imei }}</strong></td>
                    <td style="font-size: 0.85em; max-width: 300px; white-space: pre-line; line-height: 1.4;">{{ order.result_code_display or order.result_code or 'N/A' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="color: #757575; text-align: center; padding: 40px;">No orders in database yet. Import a Hammer Fusion export file to get started.</p>
        {% endif %}
    </div>
</div>

<script>
// Manual Sync & Parse functionality
document.getElementById('manual-sync-btn').addEventListener('click', function() {
    const btn = this;
    const btnText = document.getElementById('sync-btn-text');
    const statusDiv = document.getElementById('sync-status');

    // Disable button
    btn.disabled = true;
    btn.style.opacity = '0.6';
    btn.style.cursor = 'not-allowed';
    btnText.textContent = '‚è≥ Syncing...';
    statusDiv.textContent = 'Starting sync...';
    statusDiv.style.color = '#00A86B';

    // Make POST request to /manual-sync
    fetch('/manual-sync', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'parse=true'
    })
    .then(response => response.json())
    .then(data => {
        console.log('Sync response:', data);

        if (data.success) {
            // Success
            btnText.textContent = '‚úÖ Sync Complete!';
            btn.style.background = '#28a745';

            // Build status message
            let statusMsg = `Synced: ${data.stats.synced} | Completed: ${data.stats.completed} | Parsed: ${data.stats.parsed}`;
            if (data.stats.parse_failures > 0) {
                statusMsg += ` | Parse Failures: ${data.stats.parse_failures}`;
            }
            statusMsg += ` | Duration: ${data.duration}s`;

            statusDiv.textContent = statusMsg;
            statusDiv.style.color = '#28a745';

            // Show sample parsed data if available
            if (data.sample_parsed && data.sample_parsed.length > 0) {
                console.log('Sample parsed data:', data.sample_parsed);

                // Show alert with sample
                let sampleText = 'Sample Parsed Data:\n\n';
                data.sample_parsed.forEach((sample, i) => {
                    sampleText += `Order ${i + 1}: ${sample.order_id}\n`;
                    sampleText += `IMEI: ${sample.imei}\n`;
                    sampleText += `Fields: ${JSON.stringify(sample.parsed_fields, null, 2)}\n\n`;
                });

                alert(sampleText);
            }

            // Show errors if any
            if (data.errors && data.errors.length > 0) {
                console.warn('Sync errors:', data.errors);
                alert('Some errors occurred:\n' + data.errors.join('\n'));
            }

            // Reload page after 2 seconds
            setTimeout(() => {
                window.location.reload();
            }, 2000);

        } else {
            // Error
            btnText.textContent = '‚ùå Sync Failed';
            btn.style.background = '#dc3545';

            let errorMsg = data.errors && data.errors.length > 0
                ? data.errors.join(', ')
                : 'Unknown error';
            statusDiv.textContent = `Error: ${errorMsg}`;
            statusDiv.style.color = '#dc3545';

            console.error('Sync failed:', data);
            alert('Sync failed: ' + errorMsg);

            // Re-enable button after 3 seconds
            setTimeout(() => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
                btn.style.background = '#00A86B';
                btnText.textContent = 'üîÑ Manual Sync & Parse Orders';
                statusDiv.textContent = '';
            }, 3000);
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        btnText.textContent = '‚ùå Sync Failed';
        btn.style.background = '#dc3545';
        statusDiv.textContent = `Network error: ${error.message}`;
        statusDiv.style.color = '#dc3545';

        alert('Network error: ' + error.message);

        // Re-enable button after 3 seconds
        setTimeout(() => {
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
            btn.style.background = '#00A86B';
            btnText.textContent = 'üîÑ Manual Sync & Parse Orders';
            statusDiv.textContent = '';
        }, 3000);
    });
});
</script>
{% endblock %}
